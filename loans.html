<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>SP Enterprises - Simple Quickest Loan Process</title>
  <meta content="SP Enterprises offers personal loans, business loans, and financial consultation with hassle-free process." name="description">
  <meta content="loans, finance, business loan, personal loan, SP Enterprises" name="keywords">
  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  
  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Logis
  * Template URL: https://bootstrapmade.com/logis-bootstrap-logistics-website-template/
  * Updated: Aug 07 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body class="index-page">

    <header id="header" class="header d-flex align-items-center fixed-top" style="background-color:  rgba(14, 29, 52, 0.9);">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">

      <a href="https://spenterprises.tech/" class="logo d-flex align-items-center me-auto">
      <div class="logo-animation" style="height: 3.5em;">
        <lottie-player
          src="assets/img/spf_logo.json"
          background="transparent"
          speed="1"
          loop autoplay>
        </lottie-player>
        </div>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="profile.html" class="active">Home<br></a></li>
          <!-- <li><a href="#about">About</a></li> -->
          <!-- <li><a href="#services">Services</a></li> -->
          <!-- <li><a href="#testimonials">Reviews</a></li> -->
          <!-- <li><a href="#faq">Help</a></li> -->
       
          <!-- <li><a href="#contact">Contact</a></li> -->
          <!-- <li><a href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Login</a></li> -->
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>

      <!--<a class="btn-getstarted" href="get-a-quote.html">Get a Quote</a>-->

    </div>
  </header>

  <main class="main">

    <!-- Hero Section -->


    <section class="tabs-section">
    <div class="container">
        <h3 class="mb-4 mt-5 text-center">Repayment Schedule</h3>
        <!-- Tabs Content -->
        <div class="tab-content p-4 bg-white shadow-sm rounded" id="repaymentContent"></div>
    </div>

  </section>

  </main>

  <footer id="footer" class="footer dark-background">

  <div class="container footer-top">
    <div class="row gy-4">
      <div class="col-lg-5 col-md-12 footer-about">
        <a href="index.html" class="logo d-flex align-items-center">
          <span class="sitename">SP Enterprises</span>
        </a>
        <p>SP Enterprises is your trusted partner for loans, financial solutions, and business growth support. We provide reliable services, timely assistance, and personalized solutions to help you achieve your financial goals.</p>
        <div class="social-links d-flex mt-4">
          <a href="#"><i class="bi bi-twitter"></i></a>
          <a href="#"><i class="bi bi-facebook"></i></a>
          <a href="#"><i class="bi bi-instagram"></i></a>
          <a href="#"><i class="bi bi-linkedin"></i></a>
        </div>
      </div>

      <div class="col-lg-2 col-6 footer-links">
        <h4>Useful Links</h4>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="#about">About Us</a></li>
          <li><a href="#services">Services</a></li>
          <li><a href="#">Terms of Service</a></li>
          <li><a href="#">Privacy Policy</a></li>
        </ul>
      </div>

      <div class="col-lg-2 col-6 footer-links">
        <h4>Our Services</h4>
        <ul>
          <!--<li><a href="get-a-quote.html?q=Personal Loan">Personal Loans</a></li>-->
          <!--<li><a href="get-a-quote.html?q=Business Loan">Business Loans</a></li>-->
          <!--<li><a href="get-a-quote.html?q=Financiall Advisory">Financial Advisory</a></li>-->
          <!--<li><a href="get-a-quote.html?q=Short Term loan">Short Term Loan</a></li>-->
          <!--<li><a href="get-a-quote.html?q=Loan Assistance">Loan Assistance</a></li>-->
          
           <li><a href="#">Personal Loans</a></li>
          <li><a href="#">Business Loans</a></li>
          <li><a href="#">Financial Advisory</a></li>
          <li><a href="#">Short Term Loan</a></li>
          <li><a href="#">Loan Assistance</a></li>
        </ul>
      </div>

      <div class="col-lg-3 col-md-12 footer-contact text-center text-md-start">
        <h4>Contact Us</h4>
        <p>SP Enterprises Office</p>
        <p>Sr. No 10, Mahatma Phule Vasahat Pune, Maharashtra 411028</p>
        <p>India</p>
        <p class="mt-4"><strong>Phone:</strong> <span>+91 98765 43210</span></p>
        <p><strong>Email:</strong> <span>info@spenterprises.tech</span></p>
      </div>

    </div>
  </div>

 <div class="container copyright text-center mt-4">
      <p>© <span>Copyright</span> <strong class="px-1 sitename">SP Enterprises</strong> <span>All Rights Reserved</span></p>
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you've purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: [buy-url] -->
        Designed by <a href="https://bootstrapmade.com/">Pisyst India Pvt Ltd</a> Developed by  <a href="https://pisystindia.com/">Pisyst India Pvt Ltd</a>
      </div>
    </div>

</footer>



  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

 <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // repayment.html
$(document).ready(function() {
  const params = new URLSearchParams(window.location.search);
  const loanId = params.get('loanId');
  const token = localStorage.getItem('jwtToken');

  if (!loanId) {
    alert("Invalid Loan ID");
    return;
  }

  $.ajax({
    url: 'http://localhost/spfinance/mobile/repayment_schedule',
    method: 'POST',
    data: JSON.stringify({ loan_id: loanId }),
    headers: {
      'Authorization': 'Bearer ' + token
    },
    success: function(response) {
      console.log("Loan details:", response);
      renderRepaymentSchedule(response);
      // Render repayment details here
    },
    error: function(xhr) {
      console.error("Error fetching details:", xhr.responseText);
    }
  });

  function renderRepaymentSchedule(response) {
        const container = $("#repaymentContent");
        container.empty(); // Clear previous data

        if (!response || !response.success || !response.payload || !response.payload.repayments || response.payload.repayments.length === 0) {
            container.html(`
            <div class="alert alert-warning text-center">
                No repayment schedule found.
            </div>
            `);
            return;
        }

        const repayments = response.payload.repayments;
        repayments.sort((a, b) => new Date(a.due_date) - new Date(b.due_date));


        // Create table
        let tableHTML = `
            <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle text-center">
                <thead class="table-dark">
                <tr>
                    <th>Instalment Date</th>
                    <th>Instalment Amount (₹)</th>
                    <th>Status</th>
                    <th>Payment Date</th>
                    <th>Transaction ID</th>
                    <th>Payment Mode</th>
                    <th>Penalty Charges (₹)</th>
                    <th>Total Amount (₹)</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
        `;

        repayments.forEach(r => {
            // ✅ Status badge colors
            let statusBadge = '';
            switch (r.repayment_status?.toLowerCase()) {
            case 'paid':
                statusBadge = '<span class="badge bg-success">Paid</span>';
                break;
            case 'overdue':
                statusBadge = '<span class="badge bg-danger">Overdue</span>';
                break;
            case 'pending':
                statusBadge = '<span class="badge bg-warning text-dark">Pending</span>';
                break;
            case 'void':
                statusBadge = '<span class="badge bg-secondary">Void</span>';
                break;
            default:
                statusBadge = '<span class="badge bg-light text-dark">Unknown</span>';
            }

            // ✅ Transaction details
            const transactionId = r.transaction_id && r.transaction_id !== 'NA' ? r.transaction_id : '-';
            const paymentDate = r.payment_date || '-';

            // ✅ Payment mode logic
            let paymentMode = '-';
            if (r.transaction_id && r.transaction_id !== 'NA') {
            paymentMode = r.transaction_id.startsWith('OFF-') ? 'Offline' : 'Online';
            }

            // ✅ Penalty logic
            let penaltyCharges = '-';
            if (r.penalty_applied === '2') penaltyCharges = r.late_fee || '0';
            else if (r.penalty_applied === '1') penaltyCharges = r.penalty_rate || '0';
            else penaltyCharges = '0';

            // ✅ Total amount = instalment + penalty
            const totalAmount = Math.ceil(
                 parseFloat(r.base_amount || 0) + parseFloat(penaltyCharges || 0)
            );

            // ✅ Button logic
            let actionBtn = '';
            if (r.transaction_id && r.transaction_id !== 'NA') {
            actionBtn = `<button class="btn btn-secondary btn-sm" disabled>Paid</button>`;
            } else {
            actionBtn = `<button class="btn btn-primary btn-sm pay-now" data-repayment-id="${r.repayment_id}" data-loan-id="${r.loan_id}" data-amount="${totalAmount}">Pay Now</button>`;
            }

            tableHTML += `
            <tr>
                <td>${r.due_date || '-'}</td>
                <td>${r.base_amount || '-'}</td>
                <td>${statusBadge}</td>
                <td>${paymentDate}</td>
                <td>${transactionId}</td>
                <td>${paymentMode}</td>
                <td>${penaltyCharges}</td>
                <td>${totalAmount}</td>
                <td>${actionBtn}</td>
            </tr>
            `;
        });

        tableHTML += `
                </tbody>
            </table>
            </div>
        `;

        container.html(tableHTML);
        }
});

$(document).on('click', '.pay-now', function() {
  const repaymentId = $(this).data('repayment-id');
  const loanId = $(this).data('loan-id');

  // Get total amount from the table row
  const amountText = $(this).closest('tr').find('td:nth-child(8)').text().replace('₹', '');
  const amount = parseFloat(amountText.trim());

  const token = localStorage.getItem('jwtToken');
  const $button = $(this);

  Swal.fire({
  title: "Confirm Payment?",
  text: "Are you sure you want to continue!",
  icon: "warning",
  showCancelButton: true,
  confirmButtonColor: "#3085d6",
  cancelButtonColor: "#d33",
  confirmButtonText: "Yes, confirm payment!"
}).then((result) => {
  if (result.isConfirmed) {
      $.ajax({
    url: 'http://localhost/spfinance/mobile/create_order',
    method: 'POST',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + token },
    data: JSON.stringify({ loan_id: loanId, repayment_id: repaymentId, amount: amount }),
    beforeSend: function() {
      $button.prop('disabled', true).text('Processing...');
    },
    success: function(res) {
      if (res.success) {
        const options = {
         key: res.payload.key, // Razorpay key
          amount: res.payload.amount, // amount in paise
          //currency: res.currency,
          //name: "SP Enterprises",
          //description: "Loan Repayment",
          order_id: res.payload.order_id,
          loan_id: res.payload.loan_id,
          status: res.payload.status,
          handler: function (response) {
            console.log("Payment response: ", response);
            // ✅ Payment success callback
            var data = {
                loan_id: loanId,
                repayment_id: repaymentId,
                order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                payment_status: 'success'
               // razorpay_signature: response.payload.razorpay_signature
              }
            $.ajax({
              url: 'http://localhost/spfinance/mobile/transaction_status',
              method: 'POST',
              contentType: 'application/json',
              headers: { 'Authorization': 'Bearer ' + token },
              data: JSON.stringify(data),
              success: function(successRes) {
                console.log("Transaction status response:", successRes);
                Swal.fire({
                    icon: "success",
                    title: "Payment Successful: ".razorpay_payment_id,
                    showConfirmButton: false,
                    timer: 1500
                });                
                window.location.reload(); // reload repayment table
              },
              error: function(errorRes) {
                console.error("Error confirming payment on server: ", errorRes.responseText);
               Swal.fire({
                    icon: "error",
                    title: "Payment Failed: ".razorpay_payment_id,
                    message: "Please contact support." .errorRes.responseText,
                    showConfirmButton: false,
                    timer: 1500
                }); 
              }
            });
          },
          prefill: {
            name: res.borrower_name,
            email: res.email,
            contact: res.contact
          },
          theme: {
            color: "#0d6efd"
          }
        };

        const rzp1 = new Razorpay(options);
        rzp1.open();
      } else {
         Swal.fire({
                    icon: "error",
                    title: "Payment Failed: ",
                    message: "Unable to initiate payment. Please try again later.",
                    showConfirmButton: false,
                    timer: 1500
                }); 
        //alert(res.message || "Failed to create Razorpay order.");
      }
    },
    error: function(xhr) {
      console.error("Error:", xhr.responseText);
      Swal.fire({
                    icon: "error",
                    title: "Payment Failed: ",
                    message: "Unable to initiate payment. Please try again later.",
                    showConfirmButton: false,
                    timer: 1500
                }); 
    },
    complete: function() {
      $button.prop('disabled', false).text('Pay Now');
    }
  });

  }
});

  

});


  
</script>


</body>

</html>